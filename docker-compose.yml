version: '3.8'

services:
	frontend:
		build:
			context: .
			dockerfile: docker/frontend.Dockerfile
		image: fdd-frontend:local
		ports:
			- "3000:80"
		depends_on:
			- backend
		environment:
			- VITE_API_BASE_URL=http://localhost:3001/api

	backend:
		build:
			context: ./backend
			dockerfile: ../docker/backend.Dockerfile
		image: fdd-backend:local
		ports:
			- "3001:3001"
		volumes:
			- backend_uploads:/app/uploads
			- backend_reports:/app/reports
		environment:
			- PORT=3001
			- ALLOW_ML_HTTP_FALLBACK=true

	ml_service:
		build:
			context: ./ml_service
			dockerfile: ../docker/ml.Dockerfile
		image: fdd-ml:local
		ports:
			- "8001:8001"
		environment:
			- PORT=8001

volumes:
	backend_uploads:
	backend_reports:

# Notes:
# - Frontend serves the production build via nginx on port 3000.
# - Backend persists uploads and reports to named volumes so data survives restarts.


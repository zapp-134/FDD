# LABELED_BY_TOOL
# File: docker-compose.yml
# Inferred role: Docker Compose orchestration for local services
# Note: auto-generated label. Please edit the file for a more accurate description.

version: '3.8'
services:
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    ports:
      - "5173:5173"
      - "4173:4173"
    environment:
      - VITE_API_BASE=http://localhost:3001/api
    depends_on:
      - backend

  backend:
    build: ./backend
    ports:
      - "3001:3001"
    env_file: .env
    environment:
      ML_SERVICE_URL: "http://ml_service:8001"
      OPENAI_API_KEY: "${OPENAI_API_KEY}"
      LLM_PROVIDER: "gemini"
      LLM_FAIL_OPEN: "${LLM_FAIL_OPEN}"
      # GEMINI_API_KEY can be provided via host .env (API key auth). If empty, ADC (service account) will be used.
      GEMINI_API_KEY: "${GEMINI_API_KEY}"
      GEMINI_MODEL: "${GEMINI_MODEL}"
      DATABASE_URL: "sqlite:///data/jobs.db"
      MINIO_ENDPOINT: "minio:9000"
      MINIO_BUCKET: "fdd"
      GOOGLE_APPLICATION_CREDENTIALS: "/secrets/sa-key.json"
    volumes:
      - ./backend/uploads:/app/uploads
      - ./backend/reports:/app/reports
      - ./backend/data:/app/data
      - ./keys/sa-key.json:/secrets/sa-key.json:ro
    depends_on:
      - ml_service
      - minio
      # - db (disabled; backend uses SQLite by default)
    healthcheck:
      test: ["CMD-SHELL", "node -e \"const http=require('http'); http.get('http://localhost:3001/api/health', res=>{process.exit(res.statusCode>=200&&res.statusCode<400?0:1)}).on('error', ()=>process.exit(1));\""]
      interval: 10s
      timeout: 5s
      retries: 5
    command:
      - sh
      - -c
      - |
        node dist/scripts/preflight.js && node dist/ingest.js

  ml_service:
    build: ./ml_service
    ports:
      - "8001:8001"
    environment:
      - INDEX_DIR=/app/index
      - MINIO_ENDPOINT=minio:9000
    volumes:
      - ./ml_service:/app
      - ./ml_service/index:/app/index
    depends_on:
      - minio
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import sys, urllib.request; r=urllib.request.urlopen('http://localhost:8001/openapi.json'); sys.exit(0 if r.getcode()==200 else 1)\""]
      interval: 10s
      timeout: 5s
      retries: 5

  # db:
  #   image: postgres:15-alpine
  #   environment:
  #     - POSTGRES_USER=fdd
  #     - POSTGRES_PASSWORD=fddpassword
  #     - POSTGRES_DB=fdd
  #   volumes:
  #     - db-data:/var/lib/postgresql/data

  minio:
    image: minio/minio:latest
    command: server /data
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    ports:
      - "9000:9000"
    volumes:
      - minio-data:/data

volumes:
  db-data:
  minio-data:
